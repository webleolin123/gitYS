<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">
    <title>事项清单</title>
    <link class="favicon" href="./../../../images/ico/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link class="favicon" href="./../../../images/ico/favicon.ico" rel="icon" type="image/x-icon">
    <link class="favicon" href="./../../../images/ico/favicon.ico" rel="bookmark" type="image/x-icon">
    <link href="../../../js/layui/css/layui.css" rel="stylesheet"/>
    <link href="../../../css/public.css?v1.01" rel="stylesheet"/>
    <link href="../../../js/lib/font-awesome/css/font-awesome.css" rel="stylesheet"/>
    <script src="../../../js/lib/jquery.1.12.3.js"></script>
    <script charset="utf-8" src="../../../js/common/plugin.js"></script>
</head>
<style>


    .hide {
        display: none;
    }

    .layui-form-pane .layui-form-label {
        width: 150px;
    }

    .layui-form-pane .layui-input-block {
        margin-left: 150px;
    }
</style>

<body>
<!--事项清单内容维护-->
<div class="userLayer">
    <div style="padding: 15px 20px">
        <form class="layui-form  form-theme-table" id="seForm" name="userLayer">
            <div style="height: 349px;overflow-y: auto; overflow-x: hidden;">
                <input id="itemId" name="itemId" type="hidden">
                <input id="listVersion" name="listVersion" type="hidden">
                <input id="seId" name="seId" type="hidden">
                <input id="catalogId" name="catalogId" type="hidden">
                <input id="itemFillWay" name="itemFillWay" type="hidden">
                <input id="uploadStatus" name="uploadStatus" type="hidden">
                <input id="quoteItemId" name="quoteItemId" type="hidden">
                <input id="operType" name="operType" type="hidden">
                <input id="itemMeetingOrderId" name="itemMeetingOrderId" type="hidden">
                <input id="ggDelStatus" name="ggDelStatus" type="hidden">
                <input id="ggCreateUser" name="ggCreateUser" type="hidden">
                <input id="ggCreateUid" name="ggCreateUid" type="hidden">
                <input id="ggCreateDatetime" name="ggCreateDatetime" type="hidden">
                <input id="ggCreateEname" name="ggCreateEname" type="hidden">
                <input id="ggCreateEid" name="ggCreateEid" type="hidden">
                <input id="ggUpdateDatetime" name="ggUpdateDatetime" type="hidden">
                <input id="ggUpdateUser" name="ggUpdateUser" type="hidden">
                <input id="ggUpdateUid" name="ggUpdateUid" type="hidden">
                <input id="ggUpdateEname" name="ggUpdateEname" type="hidden">
                <input id="ggUpdateEid" name="ggUpdateEid" type="hidden">

                <div class="layui-row layui-col-space10">
                    <div class="layui-col-md12">
                        <div class="layui-form-item">
                            <label class="layui-form-label"><b class="red">*</b>事项名称</label>
                            <div class="layui-input-block">
                                <input autocomplete="off" class="layui-input" lay-verify="required" name="itemName"
                                       placeholder="请输入事项名称" required type="text">
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md12">
                        <div class="layui-form-item">
                            <label class="layui-form-label"><b class="red">*</b>目录首字母</label>
                            <div class="layui-input-block">
                                <input autocomplete="off" class="layui-input" lay-verify="required" name="catalogChar"
                                       readonly required style="background: #E6E7EC" type="text">
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md12">
                        <div class="layui-form-item">
                            <label class="layui-form-label"><b class="red">*</b>事项编码</label>
                            <div class="layui-input-block">
                                <input autocomplete="off" class="layui-input" lay-verify="required" name="itemCode"

                                       readonly required style="background: #E6E7EC" type="text">
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md12">
                        <div class="layui-form-item">
                            <label class="layui-form-label"><b class="red">*</b>经法律审核</label>
                            <div class="layui-input-block">
                                <input checked lay-filter="legalFlag" name="legalFlag" title="是" type="radio"
                                       value="1">
                                <input lay-filter="legalFlag" name="legalFlag" title="否" type="radio" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="layui-col-xs12">
                        <div class="layui-form-item">
                            <label class="layui-form-label hylabel"><b class="red">*</b>决策会议顺序</label>
                            <div class="layui-input-block">
                                <input class="layui-input hyinput" id="itemMeetingOrder" lay-verify="required"
                                       name="itemMeetingOrder" placeholder="请按顺序选择会议类型" readonly required type="text">
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs12">
                        <div class="layui-form-item ">
                            <div class="layui-input-block" id="orderMeeting"></div>
                        </div>
                    </div>

                    <!--   <div style="display: none">
                           <div class="layui-col-md12">
                               <div class="layui-form-item">
                                   <label class="layui-form-label"><b class="red">*</b>统一信用代码</label>
                                   <div class="layui-input-block">
                                       <input autocomplete="off" class="layui-input" lay-verify="required" name="seComcode"
                                              placeholder="请选择统一信用代码" readonly required style="background: #E6E7EC"
                                              type="text">
                                       <span class="icon-btn" id="port-choose" style="width:100px;">选择</span>
                                   </div>
                               </div>
                           </div>

                           <div class="layui-col-md6">
                               <div class="layui-form-item">
                                   <label class="layui-form-label"><b class="red">*</b>版本号(年份)</label>
                                   <div class="layui-input-block">
                                       <input autocomplete="off" class="layui-input" id="year_version" name="itemYear"
                                              placeholder="请选择版本号(年份)" readonly type="text">
                                   </div>
                               </div>
                           </div>
                           <div class="layui-col-md6">
                               <div class="layui-form-item">
                                   <label class="layui-form-label">流水号</label>
                                   <div class="layui-input-block">
                                       <input autocomplete="off" class="layui-input" name="serialNumber" readonly
                                              style="background: #E6E7EC" type="text">
                                   </div>
                               </div>
                           </div>
                           <div class="layui-col-xs6">
                               <div class="layui-form-item">
                                   <label class="layui-form-label hylabel"><b class="red">*</b>生效日期</label>
                                   <div class="layui-input-block">
                                       <input class="layui-input hyinput" id="effectTime" name="effectTime"
                                              placeholder="请选择生效日期" readonly required type="text">
                                   </div>
                               </div>
                           </div>
                           <div class="layui-col-xs6">
                               <div class="layui-form-item">
                                   <label class="layui-form-label hylabel">失效日期</label>
                                   <div class="layui-input-block">
                                       <input class="layui-input hyinput" id="expireTime" name="expireTime"
                                              placeholder="请选择失效日期" readonly type="text">
                                   </div>
                               </div>
                           </div>


                           <div class="layui-form-item">
                               <label class="layui-form-label" style="width:100%">备注</label>
                               <div class="layui-input-block" style="margin-left:0;left:0">
                                   <textarea class="layui-textarea" maxlength="256" name="remark"
                                             placeholder="请输入"></textarea>
                               </div>
                           </div>
                       </div>-->
                </div>

            </div>
            <div class="layui-form-item">
                <div class="tcenter margin-t15">
                    <button class="layui-btn" id="formSubmit" lay-filter="formSubmit" lay-submit
                        permission-btn="itemEdit">保存
                    </button>
                    <button class="layui-btn layui-btn-primary formCloseBtn"><i class="icon iconfont icon-button-cha-2" style="margin-right: 3px"></i>关闭</button>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- 选择企业选择 -->
<div class="add9" style="display: none">
    <div style="padding: 10px">
        <div class="layui-row layui-col-space10">
            <div class="layui-col-xs12">
                <ul class="eleTree ele4 unitTree" id="unitTree" lay-filter="unitTree"></ul>
            </div>
        </div>
    </div>
</div>


<script src="./../../../js/layui/layui.js"></script>
<script>
    var request = {
        getUrlParam: function (name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
            var r = window.location.search.substr(1).match(reg); //匹配目标参数
            if (r != null) return unescape(r[2]);
            return null; //返回参数值
        },
    }

    layui.config({
        base: '../../../src/js/',
        version: new Date().getTime()
    }).use(['eleTree', 'layer', 'table', 'form', 'laytpl', 'common', 'element', 'laydate'], function () {
        var table = layui.table;
        var form = layui.form;
        var tree = layui.eleTree;
        var common = layui.common;
        var element = layui.element;
        var laydate = layui.laydate;
        var util = layui.util;
        var baseUrl = '../../../';
        var currentMenuSmId = $("#currentMenuSmId", window.parent.document).val();

        var selectSeShortName = '';

        //监听复选框
        var orderMeetingTypeNames = [];
        var orderMeetingTypeIds = [];

        element.init();
        common.themeSet();

        laydate.render({
            elem: '#effectTime',
            type: 'date',
            format: 'yyyy-MM-dd'
            , trigger: 'click'
        });
        laydate.render({
            elem: '#year_version',
            type: 'year',
            format: 'yyyy',
            trigger: 'click',
            done: function (value) {
                $('input[name=itemYear]').val(value);
                //eventHandle.createItemCode();
            },
            isInitValue: true
        });
        laydate.render({
            elem: '#expireTime',
            type: 'date',
            format: 'yyyy-MM-dd'
            , trigger: 'click'
        });

        var eventHandle = {
            init: function () {
                //新增
                var catalogId = request.getUrlParam("catalogId");
                var catalogChar = request.getUrlParam("catalogChar");
                var itemId = request.getUrlParam("itemId");
                
                $('input[name=catalogChar]').val(catalogChar.substring(0,1));
                $('input[name=catalogId]').val(catalogId);
                //eventHandle.createItemCode();
                if(!itemId){
                    eventHandle.initMeetType();
                }
                
                
                //修改
                if (itemId && itemId !== "undefined") {
                    var loadingIndex = layer.load();
                    common.fetchGet('catalog/tiolItem/selectTiolItemInfoById?id=' + itemId, function (res) {
                        if (res.success) {
                            eventHandle.setForm(res.object);
                        }
                        layer.close(loadingIndex);
                    }, function () {
                        layer.close(loadingIndex);
                    });
                }else{
                    //新增
                    eventHandle.createItemCode();
                }
            },
            //生成事项编码
            createItemCode: function () {
                var catalogCodeEq = $('input[name=catalogChar]').val();
                var catalogIdEq = $('input[name=catalogId]').val();
                var listVersion = request.getUrlParam("listVersion");
                var parms = {
                    catalogIdEq: catalogIdEq,
                    catalogChar: catalogCodeEq,
                    listVersion: listVersion
                };
                common.fetchPost('catalog/tiolItem/selectItemCode', parms, function (res) {
                    if (res.success) {
                        $('input[name=itemCode]').val(res.object);
                    }
                });

            },
            //获取会议类型
            initMeetType: function (initChecks) {

                common.fetchGet('catalog/tiolMeetingType/getTiolMeetingTypeList', function (res) {
                // common.fetchPost('sasmeetingmgr/tiolMeetingType/getTiolMeetingTypeSelect', {}, function (res) {
                    if (res.success) {
                        $("#orderMeeting").empty();
                        $.each(res.list, function (index, item) {
                            var checked = "";

                            if (initChecks) {
                                var initCheckedIds = initChecks.split(",");
                                for (var i = 0; i < initCheckedIds.length; i++) {
                                    if (item.meetingTypeId == initCheckedIds[i]) {
                                        checked = "checked";
                                    }
                                }
                            }
                            $("#orderMeeting").append(" <input type=\"checkbox\" value=\"" + item.meetingTypeId + "\" name=\meetingtype\" title=\"" + item.meetingTypeName + "\" " + checked + ">");
                        });
                        form.render();
                    }

                    form.on('checkbox()', function (data) {
                        if (data.elem.checked) {
                            orderMeetingTypeNames.push(data.elem.title);
                            orderMeetingTypeIds.push(data.elem.value);
                            var newInfoName = "";
                            var newInfoId = "";
                            if (orderMeetingTypeIds != null && orderMeetingTypeIds != "") {
                                newInfoId = orderMeetingTypeIds.join(",");
                                newInfoName = orderMeetingTypeNames.join("=>");
                            } else {
                                newInfoId = orderMeetingTypeIds;
                                newInfoName = orderMeetingTypeNames;
                            }
                            $('#itemMeetingOrderId').val(newInfoId);
                            $('#itemMeetingOrder').val(newInfoName);
                        } else {
                            for (var i = 0; i < orderMeetingTypeNames.length; i++) {
                                if (orderMeetingTypeNames[i] == data.elem.title) {
                                    orderMeetingTypeNames.splice(i, 1);
                                    orderMeetingTypeIds.splice(i, 1);
                                    break;
                                }
                            }
                            var newInfo = orderMeetingTypeNames.join("=>");
                            $("#itemMeetingOrderId").val(orderMeetingTypeIds.join(","));
                            $('#itemMeetingOrder').val(newInfo);
                        }
                    });
                });
            },
            setForm: function (data) {
                orderMeetingTypeIds = (data.itemMeetingOrderId == null || data.itemMeetingOrderId == "") ? [] : data.itemMeetingOrderId.split(",");
                orderMeetingTypeNames = (data.itemMeetingOrder == null || data.itemMeetingOrder == "") ? [] : data.itemMeetingOrder.split("=>");

                $('input[name=catalogChar]').val(data.catalogChar);
                $('input[name=itemId]').val(data.itemId);
                $('input[name=itemFillWay]').val(data.itemFillWay);
                $('input[name=uploadStatus]').val(data.uploadStatus);
                $('input[name=quoteItemId]').val(data.quoteItemId);
                $('input[name=operType]').val(data.operType);
                $('input[name=catalogId]').val(data.catalogId);
                $('input[name=catalogChar]').val(data.catalogChar);
                $('input[name=seComcode]').val(data.seComcode);
                $('input[name=itemYear]').val(data.itemYear);
                $('input[name=itemCode]').val(data.itemCode);
                $('input[name=itemName]').val(data.itemName);
                $('input[name=serialNumber]').val(data.serialNumber);
                $('input[name=itemMeetingOrderId]').val(data.itemMeetingOrderId);
                $('input[name=itemMeetingOrder]').val(data.itemMeetingOrder);

                eventHandle.initMeetType(data.itemMeetingOrderId);
                $('input[name=effectTime]').val(util.toDateString(data.effectTime, 'yyyy-MM-dd'));
                $('input[name=expireTime]').val(util.toDateString(data.expireTime, 'yyyy-MM-dd'));

                $('textarea[name=remark]').val(data.remark);
                $('input[name=ggDelStatus]').val(data.ggDelStatus);
                $('input[name=ggCreateUser]').val(data.ggCreateUser);
                $('input[name=ggCreateUid]').val(data.ggCreateUid);
                $('input[name=ggCreateDatetime]').val(data.ggCreateDatetime);
                $('input[name=ggCreateEname]').val(data.ggCreateEname);
                $('input[name=ggCreateEid]').val(data.ggCreateEid);
                $('input[name=ggUpdateDatetime]').val(data.ggUpdateDatetime);
                $('input[name=ggUpdateUser]').val(data.ggUpdateUser);
                $('input[name=ggUpdateUid]').val(data.ggUpdateUid);
                $('input[name=ggUpdateEname]').val(data.ggUpdateEname);
                $('input[name=ggUpdateEid]').val(data.ggUpdateEid);
                //$('input[name=legalFlag]').val(data.legalFlag);
                $("input[name=legalFlag][value=" + data.legalFlag + "]").attr("checked", true);//value=1的radio被选中
                form.render();
            }
        };

        eventHandle.init();

        
        // 关闭
        $('.formCloseBtn').off('click').on('click', function () {
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引

            parent.layer.close(index);
        });


        //保存
        form.on('submit(formSubmit)', function (obj) {
            var params = {
                // catalogChar: obj.field.catalogChar,
                itemId: !!obj.field.itemId ? obj.field.itemId : null,
                catalogId: obj.field.catalogId,
                itemCode: obj.field.itemCode,
                legalFlag: obj.field.legalFlag,
                itemName: obj.field.itemName,
                itemMeetingOrderId: obj.field.itemMeetingOrderId,
                itemListId: request.getUrlParam("listId"),
                iSaveFlag: 0
            };
            //判断是否启动流程
            if (!common.getSystemFlowAccess()) {
                params.iSaveFlag = 1;
            }
            var loadingIndex = common.layerLoader();

            common.fetchPost('catalog/tiolItem/saveTiolItemInfo', params, function (data) {
                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                layer.close(loadingIndex);
                if (data.success) {
                    //表格重载
                    $($(top.window.document).find('#menuContent').find('.iframe')[0].contentWindow.document).find("#refreshBtn").click();
                    layer.msg('保存成功');


                    parent.layer.close(index);
                } else {
                    if (data.resultMessage) {
                        layer.msg(data.resultMessage);
                    } else {
                        layer.msg('保存失败');
                    }

                    // parent.layer.close(index);
                }
            }, function () {
                layer.close(loadingIndex);
                layer.msg('保存失败');//失败后提示
            });
            return false;

        });
        common.buttonLimit();
    });


</script>
<!--[if lt IE 9]>
<script src="../../../js/lib/html5.min.js"></script>
<script src="../../../js/lib/respond.js"></script>
<![endif]-->
</body>

</html>
